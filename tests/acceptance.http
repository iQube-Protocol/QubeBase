### QubeBase Core Hub - Acceptance Tests
### Replace {{SERVICE_ROLE_KEY}} with your actual service role key
### Replace UUIDs with actual values from your seeded data

@baseUrl = http://127.0.0.1:54321/functions/v1
@serviceKey = {{SERVICE_ROLE_KEY}}

### Test 1: Upload intake (register metadata)
POST {{baseUrl}}/upload_intake
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "name": "Test Upload",
  "description": "Test file upload",
  "tenant_id": "{{platform_tenant_uuid}}",
  "size_bytes": 1048576,
  "mime": "image/jpeg",
  "storage_uri": "blakqube/{{uuid}}/photo.jpg"
}

### Test 1-A: Soft cap test (500 MB file - advisory warning)
POST {{baseUrl}}/upload_intake
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "name": "Large Video",
  "tenant_id": "{{platform_tenant_uuid}}",
  "size_bytes": 524288000,
  "mime": "video/mp4",
  "storage_uri": "blakqube/{{uuid}}/large_video.mp4"
}

### Test 1-B: Hard cap test (1 GB file - should succeed)
POST {{baseUrl}}/upload_intake
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "name": "Max Size Video",
  "tenant_id": "{{platform_tenant_uuid}}",
  "size_bytes": 1073741824,
  "mime": "video/mp4",
  "storage_uri": "blakqube/{{uuid}}/max_video.mp4"
}

### Test 1-C: Over hard cap test (1.1 GB file - should fail)
POST {{baseUrl}}/upload_intake
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "name": "Too Large Video",
  "tenant_id": "{{platform_tenant_uuid}}",
  "size_bytes": 1181116006,
  "mime": "video/mp4",
  "storage_uri": "blakqube/{{uuid}}/too_large_video.mp4"
}

### Test 2: Issue signed URL (should pass if RLS grants allow)
POST {{baseUrl}}/issue_signed_url
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "payload_id": "{{payload_uuid}}",
  "country": "US"
}

### Test 3: Generate derivatives
POST {{baseUrl}}/generate_derivatives
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "payload_id": "{{payload_uuid}}"
}

### Test 4: Registry webhook - template upsert
POST {{baseUrl}}/registry_webhook
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "type": "template.upsert",
  "template": {
    "id": "{{template_uuid}}",
    "name": "TestTemplate.v1",
    "meta_public": {"schema": "test"}
  }
}

### Test 5: Registry webhook - instance upsert
POST {{baseUrl}}/registry_webhook
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "type": "instance.upsert",
  "instance": {
    "id": "{{instance_uuid}}",
    "template_id": "{{template_uuid}}",
    "owner_tenant_id": "{{platform_tenant_uuid}}",
    "meta_public": {"title": "Test Instance"},
    "black_pointer": "cid://test",
    "tokenqube_key_id": "keyref-test"
  }
}

### Test 6: IPFS/ICP connector (Phase 2 stub)
POST {{baseUrl}}/ipfs_icp_connector
content-type: application/json
authorization: Bearer {{serviceKey}}

{
  "payload_id": "{{payload_uuid}}",
  "tier": "ipfs_private",
  "uri": "ipfs://Qm...",
  "latency_ms": 150
}

### Test 7: Analytics refresh
POST {{baseUrl}}/analytics_refresh
content-type: application/json
authorization: Bearer {{serviceKey}}

{}

### Expected Results:
# Test 1: Should return 201 with payload_id and note (OK or SOFT_CAP_EXCEEDED)
# Test 2: Should return 200 with signed_url (or 403 if no grant)
# Test 3: Should return 200 with ok: true
# Test 4: Should return 200 with ok: true
# Test 5: Should return 200 with ok: true
# Test 6: Should return 200 with echoed data
# Test 7: Should return 200 with note about adding RPC
